<script type="text/javascript">
    RED.nodes.registerType('homeeDevice', {
        category: 'homee',
        color: '#a6bbcf',
        defaults: {
            'virtual-homee': {value: '', type: 'virtualHomee'},
            'name': {value: '', required: true},
            'nodeId': {value: '', validate: RED.validators.number(), required: true},
            'showNodeId': {value: true},
            'profile': {value: '', validate: RED.validators.number(), required: true},
            'icon': {value: 'default'},
            'attributes': {value: '', validate: RED.validators.typedInput('json'), required: true}
        },
        icon: 'homee-logo.svg',
        inputs: 1,
        outputs: 1,
        inputLabels: 'device input',
        outputLabels: 'device output',
        label: function() {
            return (this.name || 'homeeDevice') + (this.showNodeId ? ' ('+ this.nodeId +')' : '');
        },
        oneditprepare: async function () {
          $("#node-input-attributes").typedInput({
            default: 'json',
            types: ['json']
          });

          const res1 = await fetch('/homee-api/enums');
          const enums = await res1.json();

          for (profile in enums.CANodeProfile) {
            const option = document.createElement('option')
            option.setAttribute('value', enums.CANodeProfile[profile])
            option.appendChild(document.createTextNode(profile.replace('CANodeProfile', '')));

            document.querySelector('#node-input-profile').appendChild(option)
          }

          const res2 = await fetch('/homee-api/icons');
          const icons = await res2.json();

          for (icon in icons) {

            const option = document.createElement('option')
            option.setAttribute('value', icon)
            option.appendChild(document.createTextNode(icons[icon]));

            document.querySelector('#node-input-icon').appendChild(option)
          }

          document.querySelector('#node-input-profile').value = this.profile;
          document.querySelector('#node-input-icon').value = this.icon;
        }
    });
</script>

<script type="text/x-red" data-template-name="homeeDevice">
    <p><i class="fa fa-info-circle"></i> Please create and deploy a virtual homee first.</p>
    <div class="form-row">
        <label for="node-input-virtual-homee"><i class="fa fa-cube"></i> virt. homee</label>
        <input type="text" id="node-input-virtual-homee" placeholder="homee" style="width: 70%">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="homeeDevice" style="width: 70%">
    </div>
    <div class="form-row">
        <label for="node-input-nodeId"><i class="fa fa-hashtag"></i> Node-ID</label>
        <input type="number" id="node-input-nodeId" placeholder="Node-ID" style="width: 70%">
    </div>
    <div class="form-row">
        <label for="node-input-showNodeId"></label>
        <input type="checkbox" id="node-input-showNodeId" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>im Titel anzeigen</span>
    </div>
    <div class="form-row">
        <label for="node-input-profile"><i class="fa fa-id-badge"></i> Profile</label>
        <select id="node-input-profile" style="width: 70%"></select>
    </div>
    <div class="form-row">
        <label for="node-input-icon"><i class="fa fa-image"></i> Icon</label>
        <select id="node-input-icon" style="width: 70%"></select>
    </div>
    <div class="form-row">
        <label for="node-input-attributes"><i class="fa fa-code"></i> Attributes</label>
        <input type="text" id="node-input-attributes" style="width:70%">
    </div>
</script>

<script type="text/x-red" data-help-name="homeeDevice">
    <p>Simulates a homee device</p>

    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>virt. homee <span class="property-type">node</span></dt>
        <dd>Choose or create your virtual homee.</dd>
        <dt>Name <span class="property-type">string</span></dt>
        <dd>Name your device. This name shows up in homee.</dd>
        <dt>Node-ID <span class="property-type">number</span></dt>
        <dd>Specify a Node-ID. This must be unique. You can also choose to display the ID in the title of the node.</dd>
        <dt>Profile</dt>
        <dd>Choose a profile for your device.</dd>
        <dt>Icon</dt>
        <dd>Choose an icon for your device or leave it at default.</dd>
        <dt>Attributes <span class="property-type">json</span></dt>
        <dd>Add some attributes to your device. Must be an Array of Objects.</dd>
    </dl>

    <h3>Input</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">json</span></dt>
        <dd>
          <p>To update an attribute value, a JSON message must be sent to the node input.</p>
          <pre>
{
  "attribute": {
    "id": 10,
    "value": 1
  }
}
          </pre>
        </dd>
    </dl>

    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">json</span></dt>
        <dd>
          <p>Any change to an attribute value generates a JSON message with the following format.</p>
          <pre>
{
  "attributeId": 10,
  "targetValue": 1
}
          </pre>
        </dd>
    </dl>

    <h3>References</h3>
    <p>You will find more usefull hints and instructions at
        <a href="https://github.com/stfnhmplr/node-red-contrib-homee/wiki/homeeDeviceNode" title="Node-RED Contrib homee Wiki">
        https://github.com/stfnhmplr/node-red-contrib-homee/wiki/homeeDeviceNode</a>
    </p>
</script>
